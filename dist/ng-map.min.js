var ngMap=angular.module("ngMap",[]);ngMap.directive("control",["Attr2Options",function(a){var b=new a,c={mapType:function(a){var b={};for(var c in a)switch(c){case"mapTypeIds":var d=a[c].match(/\[?([A-Z,\ ]+)\]?/)[1].split(",");d=d.map(function(a){a.replace(/\s+/g,"").toUpperCase();return google.maps.MapTypeId[a.replace(/\s+/g,"")]}),b[c]=d;break;case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;case"style":b[c]=google.maps.MapTypeControlStyle[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},overviewMap:function(a){var b={};for(var c in a)switch(c){case"opened":b[c]="true"==a[c]||"1"==a[c];break;default:b[c]=a[c]}return b},pan:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;case"style":b[c]=google.maps.ScaleControlStyle[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},streetView:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},zoom:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;case"style":b[c]=google.maps.ZoomControlStyle[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},rotate:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},scale:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;case"style":b[c]=google.maps.ScaleControlStyle[a[c].toUpperCase()];break;default:b[c]=a[c]}return b}};return{restrict:"E",require:"^map",link:function(a,d,e,f){var g=new b.filter(e),h=g.name;if(delete g.name,optionBuilder=c[h]){var i=optionBuilder(g);f.controls[h]=i}else console.error(h,"does not have option builder")}}}]),ngMap.directive("map",["Attr2Options","$parse","NavigatorGeolocation","GeoCoder",function(a,b,c,d){var e=new a;return{restrict:"AE",controller:["$scope",function(a){this.map=null,this.controls={},this.markers=[],this.shapes=[],this.initializeMap=function(a,b,f){var g=e.filter(f),h=e.getOptions(g),i=this;if(h.zoom||(h.zoom=15),h.center instanceof Array){var j=h.center[0],k=h.center[1];h.center=new google.maps.LatLng(j,k)}else{var l=h.center;delete h.center}for(var m in this.controls)h[m+"Control"]="false"===this.controls[m].enabled?0:1,delete this.controls[m].enabled,h[m+"ControlOptions"]=this.controls[m];console.log("mapOptions",h),i.map=new google.maps.Map(b[0],h),"string"==typeof l?d.geocode({address:l}).then(function(a){i.map.setCenter(a[0].geometry.location)}):h.center||c.getCurrentPosition().then(function(a){var b=a.coords.latitude,c=a.coords.longitude;i.map.setCenter(new google.maps.LatLng(b,c))});var n=e.getEvents(a,g);console.log("mapEvents",n);for(var o in n)google.maps.event.addListener(i.map,o,n[o]);return a.map=i.map,i.map},this.addMarker=function(b){b.setMap(this.map),b.centered&&this.map.setCenter(b.position);var c=Object.keys(a.markers).length;a.markers[b.id||c]=b},this.initializeMarkers=function(){a.markers={};for(var b=0;b<this.markers.length;b++){var c=this.markers[b];this.addMarker(c)}},this.initializeShapes=function(){a.shapes={};for(var b=0;b<this.shapes.length;b++){var c=this.shapes[b];c.setMap(this.map),a.shapes[c.id||b+1]=c}}}],link:function(a,b,c,d){d.initializeMap(a,b,c),d.initializeMarkers(),d.initializeShapes(),a.$watchCollection("markers",function(a,b){console.log("markers are changed",b,a)})}}}]),ngMap.directive("marker",["Attr2Options","GeoCoder","NavigatorGeolocation",function(a,b,c){var d=new a;return{restrict:"E",require:"^map",link:function(a,e,f,g){var h=new d.filter(f),i=d.getOptions(h),j=d.getEvents(a,h),k=function(){var a=new google.maps.Marker(i);Object.keys(j).length>0&&console.log("markerEvents",j);for(var b in j)google.maps.event.addListener(a,b,j[b]);return a};if(i.position instanceof Array){var l=i.position[0],m=i.position[1];i.position=new google.maps.LatLng(l,m),console.log("adding marker with options, ",i);var n=k();g.markers.push(n)}else if("string"==typeof i.position){var o=i.position;o.match(/^current/i)?c.getCurrentPosition().then(function(a){var b=a.coords.latitude,c=a.coords.longitude;i.position=new google.maps.LatLng(b,c);var d=k();g.addMarker(d)}):b.geocode({address:i.position}).then(function(a){var b=a[0].geometry.location;i.position=b;var c=k();g.addMarker(c)})}else console.error("invalid marker position",i.position)}}}]),ngMap.directive("shape",["Attr2Options",function(a){var b=new a,c=function(a){return a[0]&&a[0]instanceof Array?a.map(function(a){return new google.maps.LatLng(a[0],a[1])}):new google.maps.LatLng(a[0],a[1])},d=function(a){var b=c(a);return new google.maps.LatLngBounds(b[0],b[1])},e=function(a,b){switch(a){case"circle":return b.center=c(b.center),new google.maps.Circle(b);case"polygon":return b.paths=c(b.paths),new google.maps.Polygon(b);case"polyline":return b.path=c(b.path),new google.maps.Polyline(b);case"rectangle":return b.bounds=d(b.bounds),new google.maps.Rectangle(b);case"groundOverlay":case"image":var e=b.url,f=d(b.bounds),g={opacity:b.opacity,clickable:b.clickable};return new google.maps.GroundOverlay(e,f,g)}return null};return{restrict:"E",require:"^map",link:function(a,c,d,f){var g=b.filter(d),h=g.name;delete g.name;var i=b.getOptions(g);console.log("shape",h,"options",i);var j=e(h,i);j?f.shapes.push(j):console.error("shape",h,"is not defined");var k=b.getEvents(a,g);console.log("shape",h,"events",k);for(var l in k)google.maps.event.addListener(j,l,k[l])}}}]),ngMap.provider("Attr2Options",function(){this.$get=function(){return function(){this.filter=function(a){var b={};for(var c in a)c.match(/^\$/)||c.match(/Control(Options)?$/)||(b[c]=a[c]);return b},this.getOptions=function(attrs){var options={};for(var key in attrs)if(!key.match(/^on[A-Z]/)){var val=attrs[key];try{var num=Number(val);if(isNaN(num))throw"Not a number";options[key]=num}catch(err){try{options[key]=JSON.parse(val)}catch(err){if(val.match(/^[A-Z][a-zA-Z0-9]+\(.*\)$/))try{var exp="new google.maps."+val;options[key]=eval(exp)}catch(e){options[key]=val}else if(val.match(/^[A-Z][a-zA-Z0-9]+\.[A-Z]+$/))try{options[key]=eval("google.maps."+val)}catch(e){options[key]=val}else options[key]=val}}}return options},this.getEvents=function(scope,attrs){var events={};for(var key in attrs)if(key.match(/^on[A-Z]/)){var eventName=key.replace(/^on/,"");eventName=eventName.charAt(0).toLowerCase()+eventName.slice(1),eventName=eventName.replace(/([A-Z])/g,function(a){return"_"+a.toLowerCase()});var funcName=attrs[key].replace(/\(.*\)/,""),func=scope.$eval(funcName);if(func instanceof Function)events[eventName]=func;else{var safeJs=attrs[key].replace(/[\n\r\;]/g,"");events[eventName]=function(event){eval(safeJs)}}}return events}}}}),ngMap.service("GeoCoder",["$q",function(a){return{geocode:function(b){var c=a.defer(),d=new google.maps.Geocoder;return d.geocode(b,function(a,b){b==google.maps.GeocoderStatus.OK?c.resolve(a):c.reject("Geocoder failed due to: "+b)}),c.promise}}}]),ngMap.service("NavigatorGeolocation",["$q",function(a){return{getCurrentPosition:function(){var b=a.defer();return navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){b.resolve(a)},function(a){console.error(a),b.reject(a)}):b.reject("Browser Geolocation service failed."),b.promise},watchPosition:function(){return"TODO"},clearWatch:function(){return"TODO"}}}]);