var ngMap=angular.module("ngMap",[]);ngMap.directive("control",["Attr2Options",function(a){var b={mapType:function(a){var b={};for(var c in a)switch(c){case"mapTypeIds":var d=a[c].match(/\[?([A-Z,\ ]+)\]?/)[1].split(",");d=d.map(function(a){a.replace(/\s+/g,"").toUpperCase();return google.maps.MapTypeId[a.replace(/\s+/g,"")]}),b[c]=d;break;case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;case"style":b[c]=google.maps.MapTypeControlStyle[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},overviewMap:function(a){var b={};for(var c in a)switch(c){case"opened":b[c]="true"==a[c]||"1"==a[c];break;default:b[c]=a[c]}return b},pan:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;case"style":b[c]=google.maps.ScaleControlStyle[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},streetView:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},zoom:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;case"style":b[c]=google.maps.ZoomControlStyle[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},rotate:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;default:b[c]=a[c]}return b},scale:function(a){var b={};for(var c in a)switch(c){case"position":b[c]=google.maps.ControlPosition[a[c].toUpperCase()];break;case"style":b[c]=google.maps.ScaleControlStyle[a[c].toUpperCase()];break;default:b[c]=a[c]}return b}};return{restrict:"E",require:"^map",link:function(c,d,e,f){var g=new a(e),h=g.name;if(delete g.name,optionBuilder=b[h]){var i=optionBuilder(g);f.setControl(h,i)}else console.error(h,"does not have option builder")}}}]),ngMap.directive("map",["Attr2Options","$parse",function(Attr2Options,$parse){var getOptions=function(attrs){var options={};for(var key in attrs)if(!key.match(/^on[A-Z]/)){var val=attrs[key];try{var num=Number(val);if(isNaN(num))throw"Not a number";options[key]=num}catch(err){try{options[key]=JSON.parse(val)}catch(err){if(val.match(/^[A-Z][a-zA-Z0-9]+\(.*\)$/))try{var exp="new google.maps."+val;options[key]=eval(exp)}catch(e){options[key]=val}else if(val.match(/^[A-Z][a-zA-Z0-9]+\.[A-Z]+$/))try{options[key]=eval("google.maps."+val)}catch(e){options[key]=val}else options[key]=val}}}return options},getEvents=function(a,b){var c={};for(var d in b)if(d.match(/^on[A-Z]/)){var e=d.replace(/^on/,"");e=e.charAt(0).toLowerCase()+e.slice(1),e=e.replace(/([A-Z])/g,function(a){return"_"+a.toLowerCase()});var f=b[d].replace(/\(.*\)/,""),g=a.$eval(f);g instanceof Function?c[e]=g:console.error(e,"does not have value of a function")}return c},controls={},markers=[],shapes=[];return{restrict:"AE",controller:["$scope",function(){this.getOptions=getOptions,this.getEvents=getEvents,this.setControl=function(a,b){controls[a]=b},this.addMarker=function(a){markers.push(a)},this.addShape=function(a){shapes.push(a)}}],link:function(a,b,c){var d=new Attr2Options(c),e=getOptions(d);if(e.center instanceof Array){var f=e.center[0],g=e.center[1];e.center=new google.maps.LatLng(f,g)}for(var h in controls)e[h+"Control"]="false"===controls[h].enabled?0:1,delete controls[h].enabled,e[h+"ControlOptions"]=controls[h];console.log("mapOptions",e),map=new google.maps.Map(b[0],e);var i=getEvents(a,d);console.log("mapEvents",i);for(var j in i)google.maps.event.addListener(map,j,i[j]);markers.forEach(function(a){a.setMap(map)}),shapes.forEach(function(a){a.setMap(map)}),a.map=map;for(var k={},l=0;l<markers.length;l++)k[markers[l].id||l]=markers[l];a.map.markers=k;for(var k={},l=0;l<shapes.length;l++)k[shapes[l].id||l]=shapes[l];a.map.shapes=k}}}]),ngMap.directive("marker",["Attr2Options",function(a){return{restrict:"E",require:"^map",link:function(b,c,d,e){var f=new a(d),g=e.getOptions(f);if(g.position instanceof Array){var h=g.position[0],i=g.position[1];g.position=new google.maps.LatLng(h,i)}console.log("marker options",g);var j=new google.maps.Marker(g);e.addMarker(j);var k=e.getEvents(b,f);console.log("markerEvents",k);for(var l in k)google.maps.event.addListener(j,l,k[l])}}}]),ngMap.directive("shape",["Attr2Options",function(a){var b=function(a){return a[0]&&a[0]instanceof Array?a.map(function(a){return new google.maps.LatLng(a[0],a[1])}):new google.maps.LatLng(a[0],a[1])},c=function(a){var c=b(a);return new google.maps.LatLngBounds(c[0],c[1])},d=function(a,d){switch(a){case"circle":return d.center=b(d.center),new google.maps.Circle(d);case"polygon":return d.paths=b(d.paths),new google.maps.Polygon(d);case"polyline":return d.path=b(d.path),new google.maps.Polyline(d);case"rectangle":return d.bounds=c(d.bounds),new google.maps.Rectangle(d);case"groundOverlay":case"image":var e=d.url,f=c(d.bounds),g={opacity:d.opacity,clickable:d.clickable};return new google.maps.GroundOverlay(e,f,g)}return null};return{restrict:"E",require:"^map",link:function(b,c,e,f){var g=new a(e),h=g.name;delete g.name;var i=f.getOptions(g);console.log("shape",h,"options",i);var j=d(h,i);j?f.addShape(j):console.error("shape",h,"is not defined");var k=f.getEvents(b,g);console.log("shape",h,"events",k);for(var l in k)google.maps.event.addListener(j,l,k[l])}}}]),ngMap.provider("Attr2Options",function(){this.$get=function(){return function(a){var b={};for(var c in a)c.match(/^\$/)||c.match(/Control(Options)?$/)||(b[c]=a[c]);return b}}});
